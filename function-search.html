<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flexi Java Doc Global Search</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg: #f9fafb;
      --fg: #15171a;
      --fg-subtle: #6b7280;
      --hl: #e5e7eb;
      --hl-selected: #e8eefb;
      --primary: #1676f3;
      --input-bg: #fff;
      --border: #e5e7eb;
      --radius: 9px;
      --highlight: #fcf46a;
      --highlight-fg: #252600;
    }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0; padding: 0;
      min-height: 100vh;
      transition: background .2s, color .2s;
    }
    .container {
      max-width: 560px;
      margin: 4vh auto;
      padding: 2.5em 1.2em;
      background: var(--input-bg);
      border-radius: var(--radius);
      box-shadow: 0 4px 32px 0 rgba(30,40,60,0.06);
      border: 1px solid var(--border);
      box-sizing: border-box;
    }
    h1 {
      font-weight: 700;
      font-size: 1.6em;
      text-align: center;
      margin: .25em 0 1.3em 0;
      letter-spacing: -.03em;
      color: var(--primary);
    }
    #search-bar {
      display: block;
      width: 100%;
      font-size: 1.17em;
      padding: .7em 1em;
      margin-bottom: 1.2em;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      outline: none;
      background: var(--hl);
      color: var(--fg);
      box-sizing: border-box;
      transition: border-color .15s;
    }
    #search-bar:focus { border-color: var(--primary); }
    .results {
      list-style: none; padding: 0; margin: 0;
      border-radius: var(--radius);
      overflow: visible;
      box-shadow: 0 2px 12px 0 rgba(60,70,90,0.07);
      background: var(--input-bg);
      border: 1px solid var(--border);
      min-width: 0;
      width: 100%;
      max-width: 100%;
      word-break: break-word;
      white-space: normal;
      box-sizing: border-box;
    }
    .results li {
      padding: .77em 1.1em;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      background: none;
      transition: background .13s;
      position: relative;
      word-break: break-word;
      white-space: normal;
      overflow-wrap: anywhere;
      max-width: 100%;
      box-sizing: border-box;
      min-width: 0;
      display: flex;
      flex-direction: column;
      z-index: 1;
    }
    .results li:last-child { border-bottom: none; }
    .results li.selected,
    .results li:active,
    .results li:hover {
      background: var(--hl-selected);
      z-index: 2;
    }
    .func-title {
      font-weight: 600;
      font-size: 1.07em;
      color: var(--fg);
      word-break: break-word;
      white-space: normal;
      display: block;
      max-width: 100%;
      overflow-wrap: anywhere;
    }
    .func-details {
      font-size: .98em;
      color: var(--fg-subtle);
      margin-top: 2px;
      line-height: 1.5;
      word-break: break-word;
      white-space: normal;
      max-width: 100%;
      overflow-wrap: anywhere;
      display: block;
    }
    .func-class {
      float:right;
      font-size:.95em;
      color:var(--fg-subtle);
      margin-left: 10px;
      max-width:50%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:inline-block;
      vertical-align:middle;
    }
    mark {
      background: var(--highlight);
      color: var(--highlight-fg);
      padding: 0 2px;
      border-radius: 2px;
      font-weight: 600;
      word-break: break-word;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .progress { width: 100%; height: 7px; background: var(--hl); margin: 1em 0; border-radius: 4px; overflow: hidden;}
    .progress-bar { background: var(--primary); height: 100%; width: 0%;}
    .toggle-mode {
      float: right; cursor: pointer; font-size: 1.21em; margin-top: -2em; margin-bottom: 1.1em; color: var(--fg-subtle);
      background: none; border: none;
      outline:none;
      transition: color .17s;
    }
    .toggle-mode:hover { color: var(--primary);}
    .msg {
      margin: 2em 0 0 0;
      text-align: center;
      color: var(--fg-subtle);
    }
    .tip {
      margin-top:2em;text-align:center;font-size:.96em;color:var(--fg-subtle);
    }
    @media (max-width: 600px) {
      .container {padding: .7em;}
      h1 {font-size: 1.27em;}
      .func-title, .func-details {font-size: 1em;}
      .func-class {max-width: 100%;}
    }
    /* Dark mode */
    .dark {
      --bg: #191b22;
      --fg: #e2e4e9;
      --fg-subtle: #99a0b7;
      --hl: #23263a;
      --hl-selected: #26293d;
      --input-bg: #181b21;
      --border: #222432;
      --primary: #4ea5ff;
      --highlight: #f3b94b;
      --highlight-fg: #44310b;
    }
    .dark mark { background: var(--highlight); color: var(--highlight-fg);}
  </style>
  <!-- Fuzzy Search: Fuse.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body>
  <div class="container">
    <button class="toggle-mode" id="toggle-mode" title="Toggle dark/light">&#9788;</button>
    <h1>Flexi Java Doc Global Search</h1>
    <input id="search-bar" type="text" autocomplete="off" spellcheck="false" placeholder="Search by function, method, class, or description...">
    <div class="progress" id="progress" style="display:none"><div class="progress-bar" id="progress-bar"></div></div>
    <ul class="results" id="results"></ul>
    <div id="msg" class="msg"></div>
    <div class="tip">
      <b>Tip:</b> <kbd>↑</kbd>/<kbd>↓</kbd> + <kbd>Enter</kbd> to jump. <span id="save-index-info"></span>
    </div>
  </div>
  <script>
    // --- Minimalistic Clean AI-powered Fuzzy JavaDoc Search ---
    const STORAGE_KEY = 'javadoc_func_index_v2';
    const INDEX_URLS_KEY = 'javadoc_func_index_urls_v2';
    let index = [], urls = [], results = [], selIdx = -1, fuse = null;
    const $ = id => document.getElementById(id);

    // --- Dark/Light Mode ---
    function setMode(dark) {
      document.body.classList.toggle('dark', dark);
      localStorage.setItem('javadoc_dark', dark ? "1" : "0");
      $('toggle-mode').innerHTML = dark ? "&#9790;" : "&#9788;";
    }
    setMode(localStorage.getItem('javadoc_dark')==="1");
    $('toggle-mode').onclick = () => setMode(!document.body.classList.contains('dark'));

    // --- Keyboard Navigation ---
    $('search-bar').addEventListener('keydown', e => {
      if(!results.length) return;
      if(e.key==="ArrowDown") { selIdx++; if(selIdx>=results.length)selIdx=0; updateResults();}
      else if(e.key==="ArrowUp") { selIdx--; if(selIdx<0)selIdx=results.length-1; updateResults();}
      else if(e.key==="Enter" && selIdx>=0) {
        window.open(results[selIdx].item.url, "_blank", "noopener");
      }
      else if(e.key==="Escape") { $('search-bar').blur(); }
    });

    // --- Fuzzy Search ---
    $('search-bar').addEventListener('input', e => {
      performSearch(e.target.value);
    });

    function performSearch(q) {
      if(!q.trim()) { results = []; selIdx = -1; updateResults(); return;}
      let options = {
        keys: [
          {name:'title',weight:0.48},
          {name:'signature',weight:0.28},
          {name:'classname',weight:0.12},
          {name:'description',weight:0.12}
        ],
        threshold: 0.37, // Fuzzy
        minMatchCharLength: 2,
        ignoreLocation: true,
        includeMatches: true,
        useExtendedSearch: true
      };
      if(!fuse) fuse = new Fuse(index, options);
      results = fuse.search(q).slice(0,50); // Top 50
      selIdx = 0;
      updateResults(q);
    }

    function highlight(text, matches) {
      if(!matches || !matches.length) return text;
      let s = 0, out = '', m = matches[0];
      for(let i=0; i<m.indices.length; i++) {
        let [from,to] = m.indices[i];
        out += text.slice(s,from) + '<mark>' + text.slice(from,to+1) + '</mark>';
        s = to+1;
      }
      out += text.slice(s);
      return out;
    }

    function updateResults(q='') {
      const ul = $('results');
      ul.innerHTML = '';
      results.forEach((res,i)=>{
        let {title,signature,classname,description,url} = res.item;
        // Highlight
        let matches = res.matches||[];
        let hTitle = title, hSig = signature, hClass = classname;
        matches.forEach(m=>{
          if(m.key==='title') hTitle = highlight(title,[m]);
          if(m.key==='signature') hSig = highlight(signature,[m]);
          if(m.key==='classname') hClass = highlight(classname,[m]);
        });
        let li=document.createElement('li');
        li.className = i===selIdx?'selected':'';
        li.tabIndex = 0;
        // For class name, use a span with class for ellipsis
        li.innerHTML = `<span class="func-title">${hTitle}</span>
        <div class="func-details">
          ${hSig || ''}
          <span class="func-class">${hClass||''}</span>
        </div>`;
        li.onclick = (e)=>{ e.preventDefault(); window.open(url, "_blank", "noopener"); };
        li.onmouseover = ()=>{selIdx=i;updateResults(q);}
        ul.appendChild(li);
      });
      if(!results.length) ul.innerHTML = '<li style="color:var(--fg-subtle);padding:.9em;text-align:center;">No results</li>';
    }

    // --- Index Building ---
    async function buildIndex() {
      index = []; urls = [];
      let htmlFiles = await findAllHtmlFiles();
      let total = htmlFiles.length, done = 0;
      $('progress').style.display='block';
      $('progress-bar').style.width='0%';
      for(const file of htmlFiles){
        try{
          let resp = await fetch(file);
          if(!resp.ok) continue;
          let txt = await resp.text();
          extractFunctions(txt, file);
        }catch{}
        done++;
        $('progress-bar').style.width = ((done/total)*100).toFixed(1)+'%';
      }
      $('progress').style.display='none';
      localStorage.setItem(STORAGE_KEY, JSON.stringify(index));
      localStorage.setItem(INDEX_URLS_KEY, JSON.stringify(htmlFiles));
      $('save-index-info').innerText = "Index saved ("+index.length+" functions)";
      fuse = null;
      performSearch($('search-bar').value);
    }

    // --- Extract JavaDoc functions/classes ---
    function extractFunctions(html, file) {
      let parser = new DOMParser();
      let doc = parser.parseFromString(html, "text/html");
      let h4s = doc.querySelectorAll('h4');
      h4s.forEach(h4=>{
        let title = h4.textContent.trim();
        let pre = h4.nextElementSibling;
        let signature = '';
        if(pre && pre.tagName==='PRE') signature = pre.textContent.trim();
        // Class name
        let cls = '';
        let bc = doc.querySelector('.header .subTitle')||doc.querySelector('.header .title')||doc.querySelector('title');
        if(bc) cls = bc.textContent.trim();
        // Description: find <div class="block"> after <pre>
        let desc = '';
        let block = pre && pre.nextElementSibling && pre.nextElementSibling.classList.contains('block')
          ? pre.nextElementSibling : null;
        if(block) desc = block.textContent.trim();
        // Anchor
        let anchor = h4.getAttribute('id') || h4.previousElementSibling?.getAttribute('name');
        let url = file+(anchor?('#'+anchor):'');
        // Skip class h4
        if(title.match(/^[A-Z][A-Za-z0-9_]*$/)) return;
        index.push({title, signature, classname:cls, description:desc, url});
      });
    }

    // --- Find all HTML files in this directory and subdirs ---
    async function findAllHtmlFiles() {
      if(window.location.protocol==="file:") {
        $('msg').innerHTML = "<b>Please use this in a web server (localhost)!</b><br>Local file access cannot enumerate files.";
        return [];
      }
      // Try manifest
      try {
        let resp = await fetch('index-files/files.json');
        if(resp.ok) {
          let arr = await resp.json();
          return arr.filter(x=>x.endsWith('.html'));
        }
      }catch{}
      // Guess
      let files = [];
      files.push('index.html');
      for(let i=0;i<100;i++) files.push('index-files/index-'+i+'.html');
      for(let prefix of ['com/intellinum/mia/app/ui/','com/intellinum/mia/app/event/','com/intellinum/mia/app/runtime/']) {
        for(let file of ['Table.html','TableRow.html','LOVField.html','Session.html']) {
          files.push(prefix+file);
        }
      }
      return files;
    }

    // --- Load or build index ---
    async function loadIndex() {
      let saved = localStorage.getItem(STORAGE_KEY);
      let savedUrls = localStorage.getItem(INDEX_URLS_KEY);
      if(saved && savedUrls) {
        index = JSON.parse(saved);
        urls = JSON.parse(savedUrls);
        $('save-index-info').innerText = "Index loaded ("+index.length+" functions)";
        fuse = null;
        performSearch('');
      } else {
        $('msg').innerHTML = "Indexing JavaDoc files&hellip; Please wait.";
        await buildIndex();
        $('msg').innerHTML = "";
      }
    }
    loadIndex();

    // --- Manual Reindex ---
    document.addEventListener('keydown', e=>{
      if(e.ctrlKey && e.key==='r') {
        if(confirm("Rebuild index?")) buildIndex();
      }
    });
    $('save-index-info').innerHTML = "Press <kbd>Ctrl+R</kbd> to re-index after updating docs.";
  </script>
</body>
</html>